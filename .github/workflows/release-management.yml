name: Release Management Workflow

on:
  push:
    branches:
      - 'release/*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release (major/minor/patch)'
        required: true
        default: 'patch'

permissions:
  actions: read
  checks: write
  contents: read
  deployments: write
  issues: write
  packages: read
  pull-requests: write
  repository-projects: read
  security-events: read
  statuses: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      affected_packages: ${{ steps.determine-affected-packages.outputs.affected_apps }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Context
        id: setup-context
        uses: ./.github/actions/setup-context-and-prerequisites
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Affected Packages
        id: determine-affected-packages
        uses: ./.github/actions/determine-affected-packages
        with:
          changed_files: ${{ steps.setup-context.outputs.changed_files }}
          apps_configuration: ${{ steps.setup-context.outputs.apps_configuration }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  release-management:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.setup.outputs.affected_packages) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Context
        id: setup-context
        uses: ./.github/actions/setup-context-and-prerequisites
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Version
        id: get-version
        uses: ./.github/actions/get-version
        with:
          release_type: ${{ github.event.inputs.release_type || 'patch' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump Version
        id: bump-version
        uses: ./.github/actions/bump-version
        with:
          new_version: ${{ steps.get-version.outputs.new_version }}
          affected_apps: '["${{ matrix.package }}"]'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Changelog
        id: generate-changelog
        uses: ./.github/actions/generate-changelog
        with:
          from_tag: ${{ steps.get-version.outputs.previous_version }}
          to_tag: ${{ steps.get-version.outputs.new_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Package Config
        id: get-package-config
        run: |
          package_config=$(jq -r '.config.packages.package_specific["${{ matrix.package }}"]' <<< '${{ steps.setup-context.outputs.repository-context }}')
          echo "package_path=$(echo $package_config | jq -r '.path')" >> $GITHUB_OUTPUT
          echo "build_command=$(echo $package_config | jq -r '.ci_cd.commands.build')" >> $GITHUB_OUTPUT
          echo "test_command=$(echo $package_config | jq -r '.ci_cd.commands.test')" >> $GITHUB_OUTPUT
          echo "deployment_type=$(echo $package_config | jq -r '.ci_cd.deployment.type')" >> $GITHUB_OUTPUT
          echo "deployment_config=$(echo $package_config | jq -r '.ci_cd.deployment')" >> $GITHUB_OUTPUT

      - name: Build App
        id: build-app
        uses: ./.github/actions/build-app
        with:
          working-directory: ${{ steps.get-package-config.outputs.package_path }}
          build-command: ${{ steps.get-package-config.outputs.build_command }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Tests
        id: run-tests
        uses: ./.github/actions/run-tests
        with:
          working-directory: ${{ steps.get-package-config.outputs.package_path }}
          test-command: ${{ steps.get-package-config.outputs.test_command }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get-version.outputs.new_version }}
          release_name: Release ${{ steps.get-version.outputs.new_version }}
          body: ${{ steps.generate-changelog.outputs.changelog }}
          draft: false
          prerelease: false

      - name: Generate Release Notes
        id: generate-release-notes
        uses: ./.github/actions/ai-generate-content
        with:
          ai-api-key: ${{ secrets.GOOGLE_AI_API_KEY }}
          content_type: "release_notes"
          context_data: |
            {
              "version": "${{ steps.get-version.outputs.new_version }}",
              "changelog": "${{ steps.generate-changelog.outputs.changelog }}",
              "affected_apps": ["${{ matrix.package }}"]
            }
          template_path: .github/templates/release_notes_changelog.md

      - name: Deploy App
        id: deploy-app
        uses: ./.github/actions/deploy-app
        with:
          package-name: ${{ matrix.package }}
          artifacts-path: ${{ steps.build-app.outputs.artifacts-path }}
          deployment-type: ${{ steps.get-package-config.outputs.deployment_type }}
          deployment-config: ${{ steps.get-package-config.outputs.deployment_config }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Project Documentation
        id: update-documentation
        uses: ./.github/actions/update-documentation
        with:
          affected_apps: '["${{ matrix.package }}"]'
          new_version: ${{ steps.get-version.outputs.new_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release PR
        id: create-release-pr
        uses: ./.github/actions/create-or-update-pr
        with:
          branch_name: "release-${{ steps.get-version.outputs.new_version }}"
          pr_title: "Release ${{ steps.get-version.outputs.new_version }}"
          pr_body: ${{ steps.generate-release-notes.outputs.generated_content }}
          base_branch: "main"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Notifications
        id: send-notifications
        uses: ./.github/actions/send-notification
        with:
          notification-type: "release"
          notification-data: |
            {
              "version": "${{ steps.get-version.outputs.new_version }}",
              "affected_apps": ["${{ matrix.package }}"],
              "release_url": "${{ steps.create-release.outputs.html_url }}"
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Main Branch
        id: get-main-branch
        run: |
          main_branch=$(jq -r '.config.repository.version_control.main_branches[0]' <<< '${{ steps.setup-context.outputs.repository-context }}')
          echo "main_branch=$main_branch" >> $GITHUB_OUTPUT

      - name: Update Release Branch
        id: update-release-branch
        if: success()
        uses: ./.github/actions/update-release-branch
        with:
          release_branch: ${{ github.ref }}
          main_branch: ${{ steps.get-main-branch.outputs.main_branch }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
