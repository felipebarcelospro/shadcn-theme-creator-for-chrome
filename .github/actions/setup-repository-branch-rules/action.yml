name: 'Setup Repository Branch Rules'
description: 'Sets up branch protection rules for specified branches'

inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true
  branch-patterns:
    description: 'JSON string of branch patterns to protect'
    required: true
  protection-rules:
    description: 'JSON string of protection rules to apply'
    required: true

runs:
  using: "composite"
  steps:
  - name: Apply branch protection rules
    id: apply-protection-rules
    uses: fjogeleit/http-request-action@v1
    with:
      url: https://api.github.com/repos/${{ github.repository }}/branches/${{ inputs.branch-patterns }}/protection
      method: 'PUT'
      customHeaders: '{"Authorization": "token ${{ inputs.github-token }}", "Accept": "application/vnd.github.v3+json"}'
      data: ${{ inputs.protection-rules }}

  - name: Process response
    shell: bash
    run: |
      response='${{ steps.apply-protection-rules.outputs.response }}'
      if [[ $(echo "$response" | jq -r '.message') == "null" ]]; then
        echo "Successfully applied protection rules to ${{ inputs.branch-patterns }}"
      else
        echo "Error applying protection rules to ${{ inputs.branch-patterns }}: $(echo "$response" | jq -r '.message')"
        exit 1
      fi

  - name: Generate summary
    id: generate-summary
    shell: bash
    run: |
      echo "branch-patterns=${{ inputs.branch-patterns }}" >> $GITHUB_OUTPUT
